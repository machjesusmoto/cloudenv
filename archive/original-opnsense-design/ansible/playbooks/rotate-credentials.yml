---
# T071: Credential Rotation Playbook
# Constitution I: Security-First - Automated credential rotation
# Use: ansible-playbook rotate-credentials.yml --tags [tailscale|vault|ssh-keys|all]

- name: Credential Rotation - Overview
  hosts: localhost
  gather_facts: no

  tasks:
    - name: Display rotation overview
      ansible.builtin.debug:
        msg: |
          === CloudEnv Credential Rotation ===

          This playbook helps rotate credentials for:
          1. Tailscale auth keys (--tags tailscale)
          2. Ansible Vault password (--tags vault)
          3. SSH keys (--tags ssh-keys)
          4. All credentials (--tags all)

          IMPORTANT: Some rotations require manual steps.
          Follow the prompts and instructions carefully.
          ======================================

---
# Tailscale Auth Key Rotation
- name: Rotate Tailscale Auth Key
  hosts: localhost
  gather_facts: no
  tags: [tailscale, all]

  vars_prompt:
    - name: new_tailscale_key
      prompt: |

        === Tailscale Auth Key Rotation ===

        Steps to generate new auth key:
        1. Go to https://login.tailscale.com/admin/settings/keys
        2. Click "Generate auth key..."
        3. Enable: Reusable, Ephemeral (optional), Pre-authorized
        4. Set expiration as needed
        5. Copy the generated key

        Enter new Tailscale auth key (or press Enter to skip)
      private: yes

  tasks:
    - name: Skip if no key provided
      ansible.builtin.meta: end_play
      when: new_tailscale_key | length == 0

    - name: Update Tailscale key in vault
      ansible.builtin.lineinfile:
        path: "{{ playbook_dir }}/../inventory/group_vars/vault.yml"
        regexp: "^vault_tailscale_auth_key:"
        line: "vault_tailscale_auth_key: {{ new_tailscale_key }}"
        state: present
      delegate_to: localhost
      no_log: true

    - name: Remind to re-encrypt vault
      ansible.builtin.debug:
        msg: |
          ✅ Tailscale key updated in vault.yml

          NEXT STEPS:
          1. Re-encrypt the vault file:
             ansible-vault encrypt ansible/inventory/group_vars/vault.yml

          2. Test connectivity:
             ansible firewalls -m ping

          3. If using existing nodes, re-authenticate:
             ansible-playbook tailscale.yml --tags auth

---
# Ansible Vault Password Rotation
- name: Rotate Ansible Vault Password
  hosts: localhost
  gather_facts: no
  tags: [vault, all]

  vars_prompt:
    - name: rotate_vault
      prompt: |

        === Ansible Vault Password Rotation ===

        This will help you rotate the Ansible Vault password.

        Proceed with vault password rotation? (yes/no)
      private: no

  tasks:
    - name: Skip if not confirmed
      ansible.builtin.meta: end_play
      when: rotate_vault != 'yes'

    - name: Display vault rotation instructions
      ansible.builtin.debug:
        msg: |
          === Vault Password Rotation Steps ===

          1. Decrypt current vault files:
             ansible-vault decrypt ansible/inventory/group_vars/vault.yml

          2. Generate new secure password:
             openssl rand -base64 32 > ~/.vault_pass_new
             chmod 600 ~/.vault_pass_new

          3. Re-encrypt with new password:
             ansible-vault encrypt ansible/inventory/group_vars/vault.yml \
               --new-vault-password-file ~/.vault_pass_new

          4. Update vault password file:
             mv ~/.vault_pass_new ~/.vault_pass

          5. Test decryption:
             ansible-vault view ansible/inventory/group_vars/vault.yml

          6. Secure backup of password:
             Store ~/.vault_pass in your password manager

          IMPORTANT:
          - Backup the old password until rotation is verified
          - Update any CI/CD systems with new password
          ======================================

---
# SSH Key Rotation
- name: Rotate SSH Keys
  hosts: localhost
  gather_facts: no
  tags: [ssh-keys, all]

  vars_prompt:
    - name: rotate_ssh
      prompt: |

        === SSH Key Rotation ===

        This will generate new SSH keys and deploy them.

        Proceed with SSH key rotation? (yes/no)
      private: no

  tasks:
    - name: Skip if not confirmed
      ansible.builtin.meta: end_play
      when: rotate_ssh != 'yes'

    - name: Check for existing backup
      ansible.builtin.stat:
        path: "~/.ssh/cloudenv_key.bak"
      register: ssh_backup

    - name: Backup existing key
      ansible.builtin.copy:
        src: "~/.ssh/cloudenv_key"
        dest: "~/.ssh/cloudenv_key.bak"
        mode: '0600'
      when: not ssh_backup.stat.exists
      ignore_errors: yes

    - name: Generate new SSH key pair
      ansible.builtin.command: >
        ssh-keygen -t ed25519
        -f ~/.ssh/cloudenv_key_new
        -N ""
        -C "cloudenv-{{ ansible_date_time.date }}"
      args:
        creates: ~/.ssh/cloudenv_key_new

    - name: Display SSH rotation next steps
      ansible.builtin.debug:
        msg: |
          ✅ New SSH key generated at ~/.ssh/cloudenv_key_new

          MANUAL STEPS REQUIRED:

          1. Add new public key to target hosts FIRST:
             # Copy new public key
             cat ~/.ssh/cloudenv_key_new.pub

             # Add to each host's authorized_keys
             ssh root@host "echo 'KEY' >> ~/.ssh/authorized_keys"

          2. Test new key connectivity:
             ssh -i ~/.ssh/cloudenv_key_new root@10.0.0.1
             ssh -i ~/.ssh/cloudenv_key_new root@10.0.0.10

          3. Only after testing, swap keys:
             mv ~/.ssh/cloudenv_key ~/.ssh/cloudenv_key_old
             mv ~/.ssh/cloudenv_key_new ~/.ssh/cloudenv_key
             mv ~/.ssh/cloudenv_key_new.pub ~/.ssh/cloudenv_key.pub

          4. Update Ansible inventory if key path changed

          5. After verification, remove old keys from hosts:
             # Remove old public key from authorized_keys

          WARNING: Do not remove old key until new key is verified!

---
# Rotation Schedule Reminder
- name: Credential Rotation Schedule
  hosts: localhost
  gather_facts: no
  tags: [schedule, all]

  tasks:
    - name: Display rotation schedule
      ansible.builtin.debug:
        msg: |
          === Recommended Rotation Schedule ===

          | Credential          | Frequency    | Last Rotated | Next Due    |
          |---------------------|--------------|--------------|-------------|
          | Tailscale Auth Key  | 90 days      | Check admin  | Check admin |
          | Ansible Vault Pass  | 180 days     | Manual track | Manual track|
          | SSH Keys            | 365 days     | Check dates  | Check dates |
          | OPNsense root pass  | 180 days     | Manual track | Manual track|
          | Proxmox root pass   | 180 days     | Manual track | Manual track|

          Set calendar reminders for credential rotation!

          Quick rotation commands:
          - Tailscale: ansible-playbook rotate-credentials.yml --tags tailscale
          - Vault:     ansible-playbook rotate-credentials.yml --tags vault
          - SSH:       ansible-playbook rotate-credentials.yml --tags ssh-keys
          - All:       ansible-playbook rotate-credentials.yml --tags all
          ======================================
