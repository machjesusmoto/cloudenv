#cloud-config
# Proxmox VE Cloud-Init Configuration
# Constitution I: Security-First - SSH key auth only

hostname: ${hostname}
fqdn: ${hostname}.cloudenv.local
manage_etc_hosts: true

# Disable password auth initially, will set after Proxmox install
ssh_pwauth: false

users:
  - name: root
    lock_passwd: false
    hashed_passwd: ${root_password}
    ssh_authorized_keys:
      - ${ssh_public_key}

# Package updates
package_update: true
package_upgrade: true

# Install prerequisites for Proxmox
packages:
  - wget
  - curl
  - gnupg
  - lsb-release
  - open-iscsi
  - qemu-guest-agent
  - sudo
  - vim

# Enable qemu-guest-agent
runcmd:
  # Enable and start qemu-guest-agent
  - systemctl enable qemu-guest-agent
  - systemctl start qemu-guest-agent

  # Set up Proxmox repository
  - echo "deb [arch=amd64] http://download.proxmox.com/debian/pve bookworm pve-no-subscription" > /etc/apt/sources.list.d/pve-install-repo.list
  - wget https://enterprise.proxmox.com/debian/proxmox-release-bookworm.gpg -O /etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg

  # Update hostname in /etc/hosts
  - echo "${proxmox_ip} ${hostname}.cloudenv.local ${hostname}" >> /etc/hosts

  # Configure static IP if needed (fallback to cloud-init network config)
  - |
    if ! grep -q "${proxmox_ip}" /etc/network/interfaces; then
      cat >> /etc/network/interfaces <<EOF

    auto eth0
    iface eth0 inet static
        address ${proxmox_ip}
        netmask 255.255.255.0
        gateway ${gateway_ip}
        dns-nameservers ${join(" ", dns_servers)}
    EOF
    fi

  # Note: Proxmox installation is handled by Ansible role
  # This cloud-init just prepares the base Debian system

  # Create marker file for Ansible
  - touch /var/lib/cloud/instance/proxmox-ready

# Final message
final_message: |
  Cloud-init complete for Proxmox preparation.
  System is ready for Ansible configuration.
  IP: ${proxmox_ip}
  Gateway: ${gateway_ip}

# Power state - don't reboot, let Ansible handle it
power_state:
  mode: reboot
  message: "Rebooting after cloud-init"
  timeout: 30
  condition: true
